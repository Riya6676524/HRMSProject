@model IEnumerable<HRMSModels.AttendanceModel>
@using HRMSProject.Models;
@{
    ViewBag.Title = "Manage";
}

@{
    Pager pager = ViewBag.pager;
}

<link href="~/Content/Attendance.css" rel="stylesheet" />

<div class="container mt-4">
    <h2 class="mb-4">Attendance</h2>

    @using (Html.BeginForm("Manage", "Attendance", FormMethod.Post, new { id = "attendanceForm" }))
    {
        <div class="d-flex align-items-center mb-3 mt-2">
            <div class="me-2" style="margin-top:15px; margin-bottom:15px;">
                <label for="employeeDropdown" class="me-1">Employee Name</label>
                @Html.DropDownList(
                         "empId",
                         ViewBag.IDs as List<SelectListItem>,
                         new
                         {
                             @id = "employeeDropdown",
                             @class = "form-control employee-dropdown"
                         }
                     )
            </div>

            <div class="me-2" style="margin-top:15px; margin-bottom:15px;">
                <label for="startDate" class="me-1">Start</label>
                <input type="date"
                       id="startDate"
                       name="startDate"
                       class="form-control"
                       style="width:auto;"
                       value="@ViewBag.SelectedStartDate" />
            </div>
            <div style="margin-top:15px; margin-bottom:15px;">
                <label for="endDate" class="me-1">End</label>
                <input type="date"
                       id="endDate"
                       name="endDate"
                       class="form-control"
                       style="width:auto;"
                       value="@ViewBag.SelectedEndDate" />
            </div>

            <div class="col-md-3 d-flex align-items-end">
              
                <button type="submit"
                        class="btn btn-primary w-100 text-center"
                        style="margin-top: 15px; margin-bottom: 15px; margin-left: 15px; padding-bottom: 10px">
                    Submit
                </button>

              
                @{
                    var roleId = Session["RoleID"] != null ? Convert.ToInt32(Session["RoleID"]) : 0;
                    var allowedRoles = new List<int> { 1, 2 };
                }

                @if (allowedRoles.Contains(roleId))
                {
                    <a href="@Url.Action("AttendanceRequest", "Attendance")"
                       class="btn btn-success w-100 text-center"
                       style="margin-top: 15px; margin-bottom: 15px; margin-left: 255px;">
                        Request
                    </a>
                }
            </div>


        </div>
   
  
    }

    <div id="dateError" class="text-danger mb-3" style="display:none;"></div>

    <div class="main-grid-body">
        @Html.Partial("AttendanceGridPartial", Model)
    </div>

    <script>
        // Default submit only on first page load
        window.addEventListener('DOMContentLoaded', function () {
            var startDate = document.getElementById("startDate").value;
            var endDate = document.getElementById("endDate").value;
            // If dates are default, auto-submit
            var today = new Date();
            var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            if (new Date(startDate).getTime() === firstDay.getTime() && new Date(endDate).toDateString() === today.toDateString()) {
                document.getElementById("attendanceForm").submit();
            }
        });

        // Prevent submit if end date is before start date
        document.getElementById("attendanceForm").addEventListener("submit", function (e) {
            var startDate = document.getElementById("startDate").value;
            var endDate = document.getElementById("endDate").value;
            var errorDiv = document.getElementById("dateError");

            if (startDate && endDate && new Date(endDate) < new Date(startDate)) {
                e.preventDefault(); // Stop form submission
                errorDiv.style.display = "block";
                errorDiv.innerText = "End date must be greater than or equal to Start date.";
            } else {
                errorDiv.style.display = "none"; // Clear error
            }
        });
    </script>
